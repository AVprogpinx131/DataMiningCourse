<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EE Day-Ahead Prices</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    form { margin-bottom: 1.5rem; }
    .row { margin: 0.5rem 0; }
    img { max-width: 100%; height: auto; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
    .card { border: 1px solid #ddd; padding: 8px; border-radius: 6px; }
    .muted { color: #666; }
    .loading { 
      display: none; 
      color: #007bff; 
      font-weight: bold;
      margin: 1rem 0;
    }
    .loading::after {
      content: '';
      animation: dots 1.5s infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60% { content: '...'; }
      80%, 100% { content: ''; }
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .timezone-note {
      margin-top: 10px;
      padding: 8px;
      background-color: #f0f8ff;
      border-radius: 4px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>Estonia Day-Ahead Prices</h1>

  <form action="/run" method="post" id="priceForm">
    <label for="date">Delivery date (YYYY-MM-DD):</label>
    <input id="date" name="date" type="text" value="{{ date_for_day }}" />
    <button type="submit" id="submitBtn">Run</button>
  </form>
  
  <div id="loading" class="loading">Fetching data and generating plots</div>

  {% if result %}
    {% if result.error %}
      <div class="row" style="color: red;">
        <strong>Error:</strong> {{ result.error }}
      </div>
    {% else %}
      <div class="row">
        <strong>{{ result.delivery_period }}</strong>
      </div>
      <div class="row">Lowest price: {{ result.min_price }} EUR/MWh at {{ result.min_time }}</div>
      <div class="row">Average price: {{ result.avg_price }} EUR/MWh</div>
      <div class="row">Highest price: {{ result.max_price }} EUR/MWh at {{ result.max_time }}</div>
      
      {% if result.top_3_min_prices %}
        <div style="margin-top: 20px;">
          <h3>Top 3 Lowest Prices</h3>
          <table style="width: 100%; border-collapse: collapse; max-width: 600px;">
            <thead>
              <tr style="background-color: #e8f5e8;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Time</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Price (EUR/MWh)</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in result.top_3_min_prices %}
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ entry.time }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: green; font-weight: bold;">{{ entry.price }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
      
      {% if result.top_3_max_prices %}
        <div style="margin-top: 20px;">
          <h3>Top 3 Highest Prices</h3>
          <table style="width: 100%; border-collapse: collapse; max-width: 600px;">
            <thead>
              <tr style="background-color: #ffe8e8;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Time</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Price (EUR/MWh)</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in result.top_3_max_prices %}
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ entry.time }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: red; font-weight: bold;">{{ entry.price }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% endif %}
  {% endif %}

  {% if result %}
  <div class="timezone-note">
      <strong>Note:</strong> All times shown in Estonia timezone (Europe/Tallinn), currently UTC+3. 
      Data represents 24-hour electricity prices for the selected delivery date.
  </div>
  {% endif %}

  <script>
    document.getElementById('priceForm').addEventListener('submit', function() {
      const loadingDiv = document.getElementById('loading');
      const submitBtn = document.getElementById('submitBtn');
      
      loadingDiv.style.display = 'block';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';
    });
  </script>

  <hr />
  <h2>Weekly summaries</h2>
  {% if matplotlib_missing %}
    <div class="muted">matplotlib not installed; plotting skipped. Install with: pip install matplotlib</div>
  {% endif %}

  {% if weekly_prices_url %}
    <h3>Weekly Min/Average/Max</h3>
    <img src="{{ weekly_prices_url }}" alt="Weekly prices" />
  {% endif %}

  {% if weekly_day_images %}
    <h3>Per-week Day-of-week (Min/Avg/Max)</h3>
    <div class="gallery">
      {% for img in weekly_day_images %}
        <div class="card">
          <img src="{{ img }}" />
        </div>
      {% endfor %}
    </div>
  {% endif %}

</body>
</html>
